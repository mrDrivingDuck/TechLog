# Vue.js - JavaScript Copy

Created by : Mr Dk.

2019 / 03 / 19 10:33

Nanjing, Jiangsu, China

---

## About

JavaScript 中深浅拷贝的问题

---

## Shallow Copy

浅拷贝

* 拷贝指向对象的指针
* 拷贝出的对象和源对象指向内存的 __同一块空间__

拷贝行为：

* 对于基本类型，拷贝的是基本类型的 __值__
* 对于引用类型（对象），拷贝的是 __内存地址__

系统自动提供的默认拷贝构造函数：

* 按 __位__ 拷贝对象，逐个浅拷贝
* 拷贝基本类型变量的值
* 拷贝引用类型的内存地址

因此如果对象数据包含指向堆空间的指针

应当自定义深拷贝构造函数，分配堆空间

```javascript
var obj1 = { a: 10, b: 20 };
var obj2 = obj1
```

在 ES6 中的新函数：`Object.assign()`（IE上未实现）

* 可处理第一层的深拷贝
* 总体上仍是浅拷贝，拷贝的是引用

---

## Deep Copy

深拷贝

* 拷贝对象和源对象互相独立
* 为数据成员开辟了独立的内存空间

在 JavaScript 中，一般通过 JSON 进行深拷贝：

* 调用 `JSON.stringify()` 将对象转换为字符串
* 调用 `JSON.parse()` 将字符串转换为新的对象

局限性：

* 对象的构造函数将被抛弃
* 只能处理能够被 JSON 表示的数据结构（`function` 等不行）

手写递归拷贝

> 对不起我信不过自己的手写

还可以直接使用 `Object.create()` 函数

---

## Summary

昨天在开发 Vue.js 时出现的问题

在父组件中，将 `data` 中的数据通过 prop 传入子组件

子组件中使用 prop 中的值初始化本地 `data`

在子组件中 对本地 `data` 进行修改后

没有 `$emit` 到父组件中触发事件

而父组件中的 `data` 竟然会随着子组件 `data` 的变化而变化

相当于父组件 `data` 和子组件的 `data` 被双向绑定了

而理论上应该是单向下行绑定

到最后发现 子组件中用 prop 初始化本地 `data` 时

对 prop 中的对象直接使用 `=` 进行赋值

导致了浅拷贝

父组件和子组件的 `data` 指向的是同一块内存

因此在形式上才会有诡异的双向绑定行为

以前写 C++ 或 Java 时

对于深浅拷贝 脑子里非常得清醒

而写 JS 时 尤其是外面还有一层 Vue.js 的框架

就没有太注意语言本身的一些坑了

还一直以为是对 Vue.js 框架的了解不够

---

以及 今天和中科院苏州电子研究所的所谓

__经验丰富的工程师__ 交流这个 BUG 时

他反复强调 是我在 Vue.js 中的写法问题

「这里不能这么写 balabala......」

最后我分析出来是深浅拷贝的问题

和他说的问题一点关系也没有

看来这些所谓的工程师 所谓的经验

也只是形式上的经验啊

根本没有下降到内存的层面分析问题

有些无语......

---

